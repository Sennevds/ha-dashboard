name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.1.0, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Extract version from tag
      id: get_version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
        
    - name: Update version in config.json
      shell: pwsh
      run: |
        $config = Get-Content config.json -Raw | ConvertFrom-Json
        $config.updates.current_version = "${{ steps.get_version.outputs.VERSION }}"
        $config | ConvertTo-Json -Depth 10 | Set-Content config.json
        echo "Updated config.json with version ${{ steps.get_version.outputs.VERSION }}"
        
    - name: Build executable with PyInstaller
      shell: pwsh
      run: |
        pyinstaller --noconfirm TabletHA.spec
        echo "Build completed successfully"
        
    - name: Verify build
      shell: pwsh
      run: |
        if (Test-Path "dist\TabletHA\TabletHA.exe") {
          $size = (Get-Item "dist\TabletHA\TabletHA.exe").Length / 1MB
          echo "âœ“ TabletHA.exe exists (${size:N2} MB)"
        } else {
          echo "âœ— TabletHA.exe not found!"
          exit 1
        }
        
        if (Test-Path "dist\TabletHA\_internal\config.json") {
          echo "âœ“ Config file exists"
        } else {
          echo "âœ— Config file not found!"
          exit 1
        }
        
    - name: Create portable ZIP
      shell: pwsh
      run: |
        $zipName = "TabletHA-Portable-${{ github.ref_name }}.zip"
        Compress-Archive -Path "dist\TabletHA\*" -DestinationPath $zipName -CompressionLevel Optimal
        
        $zipSize = (Get-Item $zipName).Length / 1MB
        echo "Created $zipName (${zipSize:N2} MB)"
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_OUTPUT
        
    - name: Generate release notes
      id: release_notes
      shell: pwsh
      run: |
        $notes = @"
        ## Tablet-HA ${{ github.ref_name }}
        
        ### ğŸ“¦ Installation
        
        1. Download \`TabletHA-Portable-${{ github.ref_name }}.zip\`
        2. Extract to a folder (e.g., \`C:\TabletHA\`)
        3. Run \`TabletHA.exe\`
        4. Configure by editing \`_internal\config.json\`
        
        ### âœ¨ Features
        
        - ğŸ  Full-screen Home Assistant interface
        - ğŸ‘ï¸ Webcam-based presence detection (face + pose)
        - ğŸ“± Automatic screen control
        - ğŸ³ Cookbook app switching (F1)
        - ğŸ”„ MQTT integration for remote control
        - ğŸ”„ **Automatic updates** (new in this version!)
        - ğŸ” Persistent cookies and sessions
        
        ### ğŸ“ Configuration
        
        Edit \`_internal\config.json\` to customize:
        - Home Assistant URL
        - Cookbook/Recipe URL  
        - Presence detection settings
        - Screen behavior
        - MQTT settings
        - Update preferences
        
        See README.md for detailed configuration guide.
        
        ### ğŸ”„ Updates
        
        This version includes automatic update checking! The app will:
        - Check for updates on startup
        - Notify you when new versions are available
        - Download and install updates with one click
        - Preserve your settings and data
        
        To disable automatic updates, edit \`_internal\config.json\`:
        \`\`\`json
        "updates": {
          "enabled": false
        }
        \`\`\`
        
        ### ğŸ“š Documentation
        
        See \`README.md\` in the \`_internal\` folder for:
        - Getting started guide
        - Configuration instructions
        - Presence detection setup
        - MQTT integration
        - Troubleshooting
        
        ### ğŸ’» System Requirements
        
        - Windows 10 or Windows 11
        - Webcam (IR camera recommended for tablets)
        - ~500 MB disk space
        - Internet connection for Home Assistant access
        
        ### ğŸ› Bug Reports
        
        Found an issue? Please [open an issue](https://github.com/${{ github.repository }}/issues) with:
        - Detailed description
        - Steps to reproduce
        - Screenshots if applicable
        - Your config.json (remove sensitive data)
        
        ### ğŸ“„ License
        
        See LICENSE file for details.
        
        ---
        
        **Full Changelog**: https://github.com/${{ github.repository }}/compare/...
        "@
        
        # Save to file for GitHub release
        $notes | Out-File -FilePath release_notes.md -Encoding UTF8
        echo "Release notes generated"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          TabletHA-Portable-${{ github.ref_name }}.zip
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tablet-ha-build-${{ github.ref_name }}
        path: |
          dist/TabletHA/
          *.zip
        retention-days: 30
